function LightStack(){this.Views={},this.Models={},this.add_view=function(e,t){ls.Views[e]=new t},this.init_view=function(e,t,n){t.__proto__=new View(e,t,n),t.model.on(ModelEvents.all_changed,t.show_all)},this.add_model=function(e,t){ls.Models[e]=new t},this.init_model=function(e,t,n){e.__proto__=new Model(e,t,n)},this.show_view=function(e){ls.Views[e].show()},this.show_view_only=function(e){for(var t in ls.Views)t!=e?ls.Views[t].hide():ls.Views[t].show()},this.hide_view=function(e){ls.Views[e].hide()}}function Model(e,t,n){function i(e){return jQuery.extend(!0,{},e)}function a(e,t){var n=[],i=[],a=[];for(var o in e)for(var c in e[o])t[o]&&t[o][c]||n.push(e[o]);for(var o in t)for(var c in t[o])e&&e[o]&&e[o][c]?a.push(i[o]):i.push(t[o]);return{removed:n,added:i,same:a}}e.Data=null;var o={added:[],removed:[],changed:[],all_changed:[]},c={update:function(t,i){n&&(localStorage.lightstack=JSON.stringify(e.Data)),i()},"delete":function(t,i){n&&(localStorage.lightstack=JSON.stringify(e.Data)),i()},create:function(t,i){n&&(localStorage.lightstack=JSON.stringify(e.Data)),i()},get_all:function(t){t(n?JSON.parse(localStorage.lightstack):e.Data)},get_one:function(e,t){t()}};n&&!localStorage.lightstack&&(localStorage.lightstack="{}"),t||$(function(){e.GetAll()}),this.init=function(){e.GetAll()},this.on=function(e,t){o[e].push(t)},this.set_data=function(t){e.Data=i(t),e.fire(ModelEvents.all_changed,t)},this.get=function(t){return i(e.Data[t])},this.get_all=function(){return i(e.Data)},this.add=function(t){e.Data[t.id]?(e.Data[t.id]=i(t),e.Update(t),e.fire(ModelEvents.changed,t),e.fire(ModelEvents.all_changed,e.Data)):(t.id&&""!=t.id||(t.id=(new Date).getTime()),e.Data[t.id]=i(t),e.Create(t),e.fire(ModelEvents.added,t),e.fire(ModelEvents.all_changed,e.Data))},this.update=function(t){e.Data[t.id]=i(t),e.Update(t),e.fire(ModelEvents.changed,t),e.fire(ModelEvents.all_changed,e.Data)},this["delete"]=function(t){delete e.Data[t],e.Delete(t),e.fire(ModelEvents.removed,t),e.fire(ModelEvents.all_changed,e.Data)},this.fire=function(e,t){for(var n in o[e])o[e][n](i(t))},this.set_handler=function(e,t){c[e]=t},this.add_event=function(e){o[e]=[]},this.remove_event=function(e){delete o[e]},this.GetAll=function(){c.get_all(function(t){var n={};for(var i in t)n[t[i].id]=t[i];var o=a(e.Data,n);(!e.Data||o.added.length||o.removed.length)&&e.set_data(n)})},this.Update=function(t){c.update(t,function(){e.GetAll()})},this.Create=function(t){c.create(t,function(){e.GetAll()})},this.Delete=function(t){c["delete"](t,function(){e.GetAll()})}}function View(e,t,n){var i={};t.selected_id,t.base_object,t.list_container=t.list_container||"#"+e+"-list",t.form_container=t.form_container||"#"+e+"-form",t.details_container=t.details_container||"#"+e+"-details";var a={list_draw:function(e){return"<li><a href='"+n+" #id="+e.id+"' class='item-link item-content' data-id='"+e.id+"'><div class='item-inner'><div class='item-title'><span class='location'><i class='fa fa-crosshairs'></i></span> "+e.name+" <span class='deleteItem'>delete</span></div></div></a></li>"},form_draw:function(t,n){return"<div>"+("hidden"!=n.type?n.title||t:"")+'</div><div><input class="'+(n.required?"required":"")+'" '+(n.read_only?"readonly":"")+' type="'+(n.type||"text")+'" name="'+e+"_"+t+'" placeholder="'+(n.placeholder||"")+'"></div>'},details_draw:function(){}};this.list_template=function(e){a.list_draw=e},this.form_template=function(e){a.form_draw=e},this.details_template=function(e){a.details_draw=e},this.add_listener=function(e,t,n){i[e+t]={selector:e,action:t,callback:n}},this.set_contents=function(e,n,i){"append"==i?$(e).append(n):"prepend"==i?$(e).prepend(n):$(e).html(n),t.bind_handlers()},this.bind_handlers=function(){$("#"+e+"-list li a").off("click").click(function(){t.selected_id=$(this).attr("data-id")}),$("#create-"+e).off("click").click(function(){t.create()}),t.form_container&&($(t.form_container).parent().find(".saveBtn").off("click").click(function(){t.save(),t.clear_form(),t.close_create_form()}),$(t.form_container).parent().find(".saveAndNewBtn").off("click").click(function(){t.save(),t.clear_form()}),$(t.form_container).parent().find("input").off("keyup").keyup(function(e){13==e.keyCode&&(t.save(),t.clear_form(),t.close_create_form())}));for(var n in i)$(i[n].selector).off(i[n].action).on(i[n].action,i[n].callback)},this.load=function(e){t.model.get_one(e,function(){})},this.create=function(){if(t.base_object){var e="";for(var n in t.base_object)e+=a.form_draw(n,t.base_object[n]);t.set_contents(t.form_container,e)}else console.error("Error: Please define a base_object for this view.")},this.populate_pickers=function(){Views[e].populate_pickers&&Views[e].populate_pickers()},this.clear_form=function(){$(t.form_container).find("input").each(function(e){$(this).val("")})},this.close_create_form=function(){},this.save=function(){var n={};$(t.form_container).find("input").each(function(t){var i=$(this).attr("name").replace(e+"_","");n[i]=$(this).val()||("checkbox"==$(this).attr("type")?"checked"==$(this).attr("checked")?!0:!1:"")}),t.model.add(n)},this.show_all=function(e){var n="";for(var i in e)n+=a.list_draw(e[i]),t.base_object||(t.base_object=e[i]);t.set_contents(t.list_container,n)}}var ls=new LightStack,ModelEvents={added:"added",removed:"removed",changed:"changed",all_changed:"all_changed"},Views={};